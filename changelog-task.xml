<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!-- Set ids from sequences using command: SELECT nextval('tableName_id_seq'). -->
    <property name="organization_id_10" value="10" />
    <!-- Debtors. -->
    <property name="organization_id_12" value="12" />
    <property name="organization_id_14" value="14" />
    <property name="organization_id_16" value="16" />
    <!-- ========= -->

    <property name="contract_id_10" value="10" />
    <!-- For debtors. -->
    <property name="contract_id_12" value="12" />
    <property name="contract_id_14" value="14" />
    <property name="contract_id_16" value="16" />
    <property name="contract_id_18" value="18" />
    <!-- =========== -->

    <property name="location_moscow_id_10" value="10" />
    <property name="location_smolensk_id_12" value="12" />
    <property name="location_perm_id_14" value="14" />

    <property name="payment_id_10" value="10" />

    <property name="product_bred_id_10" value="10" />
    <property name="product_button_id_12" value="12" />
    <property name="product_water_id_14" value="14" />


    <property name="shipment_id_10" value="10" />
    <!-- For debtors. -->
    <property name="shipment_id_12" value="12" />
    <property name="shipment_id_14" value="14" />
    <property name="shipment_id_16" value="16" />
    <!-- =========== -->

    <property name="audit_id_10" value="10" />


    <!--<changeSet id="clear_data" author="dinar">-->
        <!--<dropTable tableName="payment"/>-->
        <!--<dropTable tableName="organization"/>-->
        <!--<dropTable tableName="contract"/>-->
        <!--<dropTable tableName="location"/>-->
        <!--<dropTable tableName="product"/>-->
        <!--<dropTable tableName="shipment"/>-->

        <!--<dropSequence sequenceName="contract_id_seq" />-->
        <!--<dropSequence sequenceName="location_id_seq" />-->
        <!--<dropSequence sequenceName="organization_id_seq" />-->
        <!--<dropSequence sequenceName="payment_id_seq" />-->
        <!--<dropSequence sequenceName="product_id_seq" />-->
        <!--<dropSequence sequenceName="shipment_id_seq" />-->
        <!--<dropSequence sequenceName="audit_id_seq" />-->

        <!--<sql dbms="postgresql" endDelimiter=";">-->
            <!--DROP TRIGGER contract_amount_more_1000 ON contract-->
        <!--</sql>-->
        <!--<sql dbms="postgresql" endDelimiter=";">-->
            <!--DROP FUNCTION add_record_to_audit()-->
        <!--</sql>-->
    <!--</changeSet>-->


    <!-- Create tables. -->
    <changeSet id="create_table" author="dinar">
        <createTable tableName="organization">
            <column name="id" type="bigint">
                <constraints primaryKey="true" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="product">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="location">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="city" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="contract">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="amount" type="money">
                <constraints nullable="false" />
            </column>
            <column name="details" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="shipment">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="date_real" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="date_expect" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="product_counter" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="is_delivered" type="boolean">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="payment">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="money">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_organization_payment"
                             references="organization(id)"
                />
            </column>
            <column name="product_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_product_payment" references="product(id)" />
            </column>
            <column name="location_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_location_payment" references="location(id)"/>
            </column>
            <column name="contract_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_contract_payment" references="contract(id)"/>
            </column>
            <column name="shipment_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_shipment_Payment" references="shipment(id)"/>
            </column>
        </createTable>

        <createTable tableName="audit">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" />
            </column>
            <column name="contract_ident" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>


    <!-- Set functions. -->
    <changeSet id="create_funcs" author="dinar">
        <createProcedure dbms="postgresql">
            CREATE OR REPLACE FUNCTION add_record_to_audit()
            RETURNS trigger AS
            $$
            DECLARE
            new_audit_id bigint;
            BEGIN
            IF NEW.amount &gt; 1000 THEN
            new_audit_id:= (SELECT nextval('audit_id_seq'));
            INSERT INTO audit(id, contract_ident)
            VALUES (new_audit_id, NEW.id);
            end if;
            RETURN NEW;
            END
            $$ LANGUAGE plpgsql;
        </createProcedure>

        <createProcedure dbms="postgresql">
            CREATE OR REPLACE FUNCTION split_product_counter_by_10()
            RETURNS trigger AS
            $$
            DECLARE
            product_num bigint;
            new_id bigint;
            BEGIN
            product_num := NEW.product_counter;

            IF product_num &gt; 10 THEN
                WHILE product_num &gt; 0 LOOP
                    new_id := (SELECT nextval('shipment_id_seq'));

                    IF product_num &gt;= 10 THEN
                        INSERT INTO shipment(id, date_real, date_expect, product_counter)
                        VALUES (new_id, NEW.date_real, NEW.date_expect, 10);
                    ELSE
                        INSERT INTO shipment(id, date_real, date_expect, product_counter)
                        VALUES (new_id, NEW.date_real, NEW.date_expect, product_num);
                    END IF;

                    product_num := product_num - 10;
                END LOOP;
                RETURN NULL;
            END IF;

            RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
        </createProcedure>
    </changeSet>


    <changeSet id="create_triggers" author="dinar">
        <sql dbms="postgresql">
            CREATE TRIGGER contract_amount_more_1000
            AFTER INSERT
            ON contract
            FOR EACH ROW
            EXECUTE PROCEDURE add_record_to_audit();
        </sql>
        <sql dbms="postgresql">
            CREATE TRIGGER split_shipment
            BEFORE INSERT
            ON shipment
            FOR EACH ROW
            EXECUTE PROCEDURE split_product_counter_by_10();
        </sql>
    </changeSet>



    <!-- Set constraints. -->
    <changeSet id="set_constraints" author="dinar">
        <!-- Payment amount restriction: amount < 500.  -->
        <sql dbms="postgresql" endDelimiter=";" >ALTER TABLE payment ADD CONSTRAINT check_max_amount CHECK (amount &lt; 500)</sql>



    </changeSet>


    <!-- Set sequences. -->
    <changeSet id="create_sequences" author="dinar">
        <createSequence
                sequenceName="organization_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="contract_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="location_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="payment_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="product_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="shipment_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="audit_id_seq"
                incrementBy="2"
                startValue="10"
        />
    </changeSet>




    <!-- Fill data for simple tables. -->
    <changeSet id="5" author="dinar">

        <insert tableName="organization">
            <column name="id" valueComputed="(SELECT nextval('organization_id_seq'))" />
            <column name="name">Org1</column>
        </insert>
        <!-- Debtors. -->
        <insert tableName="organization">
            <column name="id" valueComputed="(SELECT nextval('organization_id_seq'))" />
            <column name="name">DebtorOrg2</column>
        </insert>
        <insert tableName="organization">
            <column name="id" valueComputed="(SELECT nextval('organization_id_seq'))" />
            <column name="name">DebtorOrg3</column>
        </insert>
        <insert tableName="organization">
            <column name="id" valueComputed="(SELECT nextval('organization_id_seq'))" />
            <column name="name">DebtorOrg4</column>
        </insert>
        <!--===========-->

        <insert tableName="product">
            <column name="id" valueComputed="(SELECT nextval('product_id_seq'))" />
            <column name="name">bred</column>
        </insert>
        <insert tableName="product">
            <column name="id" valueComputed="(SELECT nextval('product_id_seq'))" />
            <column name="name">button</column>
        </insert>
        <insert tableName="product">
            <column name="id" valueComputed="(SELECT nextval('product_id_seq'))" />
            <column name="name">water</column>
        </insert>


        <insert tableName="location">
            <column name="id" valueComputed="(SELECT nextval('location_id_seq'))" />
            <column name="city">Moscow</column>
            <column name="address">123 Lenina street</column>
        </insert>
        <insert tableName="location">
            <column name="id" valueComputed="(SELECT nextval('location_id_seq'))" />
            <column name="city">Smolensk</column>
            <column name="address">35 Petrova street</column>
        </insert>
        <insert tableName="location">
            <column name="id" valueComputed="(SELECT nextval('location_id_seq'))" />
            <column name="city">Perm</column>
            <column name="address">12 Sadovaya street</column>
        </insert>

        <insert tableName="contract">
            <column name="id" valueComputed="(SELECT nextval('contract_id_seq'))" />
            <column name="amount">200</column>
            <column name="details">Simple contract.</column>
        </insert>
        <!-- For debtors. -->
        <insert tableName="contract">
            <column name="id" valueComputed="(SELECT nextval('contract_id_seq'))" />
            <column name="amount">500</column>
            <column name="details">Simple contract2.</column>
        </insert>
        <insert tableName="contract">
            <column name="id" valueComputed="(SELECT nextval('contract_id_seq'))" />
            <column name="amount">600</column>
            <column name="details">Simple contract3.</column>
        </insert>
        <insert tableName="contract">
            <column name="id" valueComputed="(SELECT nextval('contract_id_seq'))" />
            <column name="amount">700</column>
            <column name="details">Simple contract4.</column>
        </insert>
        <!--=============-->
        <insert tableName="contract">
            <column name="id" valueComputed="(SELECT nextval('contract_id_seq'))" />
            <column name="amount">320</column>
            <column name="details">Simple contract.</column>
        </insert>

        <insert tableName="shipment">
            <column name="id" valueComputed="(SELECT nextval('shipment_id_seq'))" />
            <column name="date_real">2018-09-21</column>
            <column name="date_expect">2018-09-23</column>
            <column name="product_counter">5</column>
            <column name="is_delivered">false</column>
        </insert>
        <!-- For debtors. -->
        <insert tableName="shipment">
            <column name="id" valueComputed="(SELECT nextval('shipment_id_seq'))" />
            <column name="date_real">2018-11-06</column>
            <column name="date_expect">2018-11-09</column>
            <column name="product_counter">3</column>
            <column name="is_delivered">true</column>
        </insert>
        <insert tableName="shipment">
            <column name="id" valueComputed="(SELECT nextval('shipment_id_seq'))" />
            <column name="date_real">2018-08-15</column>
            <column name="date_expect">2018-08-18</column>
            <column name="product_counter">2</column>
            <column name="is_delivered">true</column>
        </insert>
        <insert tableName="shipment">
            <column name="id" valueComputed="(SELECT nextval('shipment_id_seq'))" />
            <column name="date_real">2018-05-05</column>
            <column name="date_expect">2018-05-10</column>
            <column name="product_counter">1</column>
            <column name="is_delivered">true</column>
        </insert>
        <!--===========-->
    </changeSet>

    <changeSet id="6" author="dinar">
        <insert tableName="payment">
            <column name="id" valueComputed="(SELECT nextval('payment_id_seq'))" />
            <column name="type">Payment for goods</column>
            <column name="date">2018-09-21</column>
            <column name="amount">400</column>
            <column name="organization_id">${organization_id_10}</column>
            <column name="product_id">${product_bred_id_10}</column>
            <column name="location_id">${location_moscow_id_10}</column>
            <column name="contract_id">${contract_id_10}</column>
            <column name="shipment_id">${shipment_id_10}</column>
        </insert>
        <!-- For debtors. -->
        <insert tableName="payment">
            <column name="id" valueComputed="(SELECT nextval('payment_id_seq'))" />
            <column name="type">Payment for goods</column>
            <column name="date">2018-04-21</column>
            <column name="amount">100</column>
            <column name="organization_id">${organization_id_12}</column>
            <column name="product_id">${product_button_id_12}</column>
            <column name="location_id">${location_smolensk_id_12}</column>
            <column name="contract_id">${contract_id_12}</column>
            <column name="shipment_id">${shipment_id_12}</column>
        </insert>
        <insert tableName="payment">
            <column name="id" valueComputed="(SELECT nextval('payment_id_seq'))" />
            <column name="type">Payment for goods</column>
            <column name="date">2018-03-12</column>
            <column name="amount">400</column>
            <column name="organization_id">${organization_id_14}</column>
            <column name="product_id">${product_water_id_14}</column>
            <column name="location_id">${location_perm_id_14}</column>
            <column name="contract_id">${contract_id_14}</column>
            <column name="shipment_id">${shipment_id_14}</column>
        </insert>
        <insert tableName="payment">
            <column name="id" valueComputed="(SELECT nextval('payment_id_seq'))" />
            <column name="type">Payment for goods</column>
            <column name="date">2018-01-25</column>
            <column name="amount">450</column>
            <column name="organization_id">${organization_id_16}</column>
            <column name="product_id">${product_button_id_12}</column>
            <column name="location_id">${location_smolensk_id_12}</column>
            <column name="contract_id">${contract_id_16}</column>
            <column name="shipment_id">${shipment_id_16}</column>
        </insert>
        <!-- ============ -->
        <insert tableName="payment">
            <column name="id" valueComputed="(SELECT nextval('payment_id_seq'))" />
            <column name="type">Payment for goods</column>
            <column name="date">2018-04-21</column>
            <column name="amount">320</column>
            <column name="organization_id">${organization_id_12}</column>
            <column name="product_id">${product_button_id_12}</column>
            <column name="location_id">${location_smolensk_id_12}</column>
            <column name="contract_id">${contract_id_18}</column>
            <column name="shipment_id">${shipment_id_12}</column>
        </insert>
    </changeSet>

</databaseChangeLog>





