<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!-- Set ids from sequences using command: SELECT nextval('tableName_id_seq'). -->
    <property name="organization_id_10" value="10" />
    <property name="organization_id_12" value="12" />

    <property name="contract_id_10" value="10" />

    <property name="location_id_10" value="10" />

    <property name="payment_id_10" value="10" />

    <property name="product_id_10" value="10" />

    <property name="shipment_id_10" value="10" />

    <property name="audit_id_10" value="10" />


    <!--<changeSet id="clear_data" author="dinar">-->
        <!--<dropTable tableName="payment"/>-->
        <!--<dropTable tableName="organization"/>-->
        <!--<dropTable tableName="contract"/>-->
        <!--<dropTable tableName="location"/>-->
        <!--<dropTable tableName="product"/>-->
        <!--<dropTable tableName="shipment"/>-->

        <!--<dropSequence sequenceName="contract_id_seq" />-->
        <!--<dropSequence sequenceName="location_id_seq" />-->
        <!--<dropSequence sequenceName="organization_id_seq" />-->
        <!--<dropSequence sequenceName="payment_id_seq" />-->
        <!--<dropSequence sequenceName="product_id_seq" />-->
        <!--<dropSequence sequenceName="shipment_id_seq" />-->
        <!--<dropSequence sequenceName="audit_id_seq" />-->

        <!--<sql dbms="postgresql" endDelimiter=";">-->
            <!--DROP TRIGGER contract_amount_more_1000 ON contract-->
        <!--</sql>-->
        <!--<sql dbms="postgresql" endDelimiter=";">-->
            <!--DROP FUNCTION add_record_to_audit()-->
        <!--</sql>-->
    <!--</changeSet>-->


    <!-- Create tables. -->
    <changeSet id="create_table" author="dinar">
        <createTable tableName="organization">
            <column name="id" type="bigint">
                <constraints primaryKey="true" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="product">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="location">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="city" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="contract">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="amount" type="money">
                <constraints nullable="false" />
            </column>
            <column name="details" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="shipment">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="date_real" type="timestamp">
                <constraints nullable="false" />
            </column>
            <column name="date_expect" type="timestamp">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="payment">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="type" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="money">
                <constraints nullable="false" />
            </column>

            <column name="organization_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_organization_payment"
                             references="organization(id)"
                />
            </column>
            <column name="product_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_product_payment" references="product(id)" />
            </column>
            <column name="location_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_location_payment" references="location(id)"/>
            </column>
            <column name="contract_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_contract_payment" references="contract(id)"/>
            </column>
            <column name="shipment_id" type="BIGINT">
                <constraints nullable="false" foreignKeyName="fk_shipment_Payment" references="shipment(id)"/>
            </column>
        </createTable>

        <createTable tableName="audit">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" />
            </column>
            <column name="contract_ident" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>


    <!-- Set functions. -->
    <changeSet id="create_funcs" author="dinar">
        <createProcedure dbms="postgresql">
            CREATE OR REPLACE FUNCTION add_record_to_audit()
            RETURNS trigger AS
            $$
            DECLARE
            new_audit_id bigint;
            BEGIN
            IF NEW.amount &gt; 1000 THEN
            new_audit_id:= (SELECT nextval('audit_id_seq'));
            INSERT INTO audit(id, contract_ident)
            VALUES (new_audit_id, NEW.id);
            end if;
            RETURN NEW;
            END
            $$ LANGUAGE plpgsql;
        </createProcedure>
    </changeSet>


    <changeSet id="create_triggers" author="dinar">
        <sql dbms="postgresql">
            CREATE TRIGGER contract_amount_more_1000
            AFTER INSERT
            ON contract
            FOR EACH ROW
            EXECUTE PROCEDURE add_record_to_audit();
        </sql>
    </changeSet>



    <!-- Set constraints. -->
    <changeSet id="set_constraints" author="dinar">
        <!-- Payment amount restriction: amount < 500.  -->
        <sql dbms="postgresql" endDelimiter=";" >ALTER TABLE payment ADD CONSTRAINT check_max_amount CHECK (amount &lt; 500)</sql>



    </changeSet>


    <!-- Set sequences. -->
    <changeSet id="create_sequences" author="dinar">
        <createSequence
                sequenceName="organization_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="contract_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="location_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="payment_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="product_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="shipment_id_seq"
                incrementBy="2"
                startValue="10"
        />
        <createSequence
                sequenceName="audit_id_seq"
                incrementBy="2"
                startValue="10"
        />
    </changeSet>




    <!-- Fill data for simple tables. -->
    <changeSet id="5" author="dinar">

        <insert tableName="organization">
            <column name="id">${organization_id_10}</column>
            <column name="name">Org1</column>
        </insert>
        <insert tableName="organization">
            <column name="id">${organization_id_12}</column>
            <column name="name">Org2</column>
        </insert>

        <insert tableName="product">
            <column name="id">${product_id_10}</column>
            <column name="name">bred</column>
        </insert>

        <insert tableName="location">
            <column name="id">${location_id_10}</column>
            <column name="city">Moscow</column>
            <column name="address">123 Lenina street</column>
        </insert>

        <insert tableName="contract">
            <column name="id">${contract_id_10}</column>
            <column name="amount">200</column>
            <column name="details">Simple contract.</column>
        </insert>

        <insert tableName="shipment">
            <column name="id">${shipment_id_10}</column>
            <column name="date_real">2018-09-21</column>
            <column name="date_expect">2018-09-23</column>
        </insert>
    </changeSet>

    <changeSet id="6" author="dinar">
        <insert tableName="payment">
            <column name="id">${payment_id_10}</column>
            <column name="type">Payment for goods</column>
            <column name="date">2018-09-21</column>
            <column name="amount">400</column>
            <column name="organization_id">${organization_id_10}</column>
            <column name="product_id">${product_id_10}</column>
            <column name="location_id">${location_id_10}</column>
            <column name="contract_id">${contract_id_10}</column>
            <column name="shipment_id">${shipment_id_10}</column>
        </insert>
    </changeSet>

</databaseChangeLog>





